
# Proposal. Migraci√≥n a pnpm desde Yarn Berry

---
üá™üá∏ Idioma: Espa√±ol
üóìÔ∏è Creado: 22/01/2023

---


> Yarn Berry lleva operativo desde 2020. Lo adoptamos en 2021 en la medida en que esto era posible (m√°s sobre esto luego).  Han pasado m√°s de dos a√±os y estamos asumiendo las peculiaridades de su modo de configuraci√≥n sin hacernos beneficiarios de su principal ventaja, la feature de *Plug and Play (PnP)*. 
> 
> Durante este tiempo, trabajar con esta herramienta se ha vuelto transparente para nosotros. Funciona (casi siempre), as√≠ que no pensamos m√°s en ello. Es hora de hacer tomar una decisi√≥n consciente sobre c√≥mo gestionar las dependencias de nuestras aplicaciones. 
> 
> En este art√≠culo se explica a alto nivel que son los gestores de paquetes de node, qu√© es Yarn Classic, Yarn Berry y sus diferencias, y cu√°les son las limitaciones y desventajas de Yarn Berry de acuerdo al uso actual que le damos en nuestros proyectos. Como alternativa, se propone el uso de **pnpm** y se explican sus ventajas con respecto a Yarn Berry y npm.


## ¬øQu√© es Yarn?
Yarn es un gestor de paquetes de node. Nos ayuda a controlar las dependencias de la aplicaci√≥n. Los gestores de paquetes nacieron en 2010 con npm, que introdujo el concepto de `package.json` , un archivo de manifiesto donde declarar las dependencias, y el directorio de `node_modules`, para almacenarlas. Tambi√©n introdujo scripts para automatizar la instalaci√≥n y actualizaci√≥n de dependencias. Antes, todo eso se hac√≠a manualmente.

Yarn se apareci√≥ en el 2016 como competencia de `npm`, mejorando muchos aspectos de consistencia, perfomance y seguridad, con los que `npm` hab√≠a sido negligente a pesar de las peticiones de sus usuarios. Esto le vali√≥ una r√°pida adopci√≥n. Con el tiempo, `npm` reaccion√≥ a la entrada de `yarn` e incorpor√≥ muchas de sus features.

## ¬øQu√© es Yarn Berry?

**El producto**
En 2020, aparece Yarn 2 (aka Yarn Berry). Yarn 2 caus√≥ una gran pol√©mica, porque no se trata de una nueva versi√≥n de Yarn, si no de una forma completamente nueva de lidiar con las dependencias, que romp√≠a tanto con Yarn 1 como con npm. 
La motivaci√≥n de Yarn 2 es solucionar "el problema de node modules", que para no entrar en detalles, podemos resumir con el cl√°sico meme:

![Node modules](/node-modules-heaviest.webp)

T√≠picamente para resolver una dependencia, node busca en node_modules por el archivo requerido. Es una operaci√≥n llamada *resolve*. Los gestores de paquetes tienen que ser compatibles con la l√≥gica de resoluci√≥n de node. La manera de node es copiar archivos en `node_modules`. Esto lleva tiempo, adem√°s `node_modules` se convierte en un directorio muy pesado. 

Yarn 2 propone un sistema alternativo llamado *Plug and Play (PNP)*. √âste reemplaza el comportamiento por defecto de node, por su propia implementaci√≥n, m√°s optimizada. Yarn 2 almacena cada paquete como un archivo comprimido, en formato .zip, en el directorio `.yarn/cache`. Cuando node requiere un archivo, Yarn 2 intercepta la petici√≥n, va a este directorio a por el archivo y lo pasa a node.

La idea es que es garantizar mayor velocidad y ocupar menos espacio en disco. Adem√°s, la cache de Yarn es tan compacta con respecto a `node_modules` que se puede guardar en el repositorio, lo que da al proyecto una gran autonom√≠a: como todo est√° en la cach√©, se puede hacer una build sin depender de repositorios externos (npm registry) o incluso sin tener acceso a red.  
As√≠ solo se depende del repositorio de paquetes (npm registry) al a√±adir o actualizar dependencias.

**La pol√©mica**
Esto, que en el papel suena muy bien, caus√≥ mucho rechazo en la comunidad de desarrollo. Veamos porqu√©:

1. PnP rompe con el status quo. A pesar de ser una idea innovadora y esencialmente buena, obliga a todo el ecosistema a cambiar su forma de trabajar para integrarlo y a realizar un trabajo de migraci√≥n bastante exigente. Adem√°s, su adopci√≥n obliga a los autores de Open Source y a las librer√≠as a forzar a su vez a sus usuarios a utilizar este sistema, cuando `npm` es una opci√≥n por defecto que funciona sin esfuerzo por parte del usuario. Esa es la raz√≥n por la que **muchos autores de Open Source (Kent C. Dodds, Dan Abramov, Jared Palmer) y grandes librer√≠as lo rechazaron (Twitter, Facebook)** y declararon que se mantendr√≠an en la version 1. 
   
   M√°s sobre esto: https://youtu.be/bPae4Z8BFt8?t=194
   
2. Con la entrada de Yarn 2, Yarn 1 se convert√≠a en un repositorio legacy. Yarn opt√≥ por una estrategia de lanzamiento agresiva, para forzar a la comunidad a introducir PnP. La afirmaci√≥n de que Yarn 1 era legacy provoc√≥ bastante alarma, especialmente cuando buena parte de los usuarios no ten√≠an posibilidad de migrar a Yarn 2.  Los autores ten√≠an la intenci√≥n de mantenerlo simplemente arreglando potenciales vulnerabilidades, y archivarlo permanentemente en un par de a√±os (spoiler, no tiene pinta de que esto vaya a pasar pronto). 
   El cambio de Yarn 1 a Yarn 2 es tan radical, que Yarn 1 recibi√≥ el nombre de Yarn Classic y Yarn 2 el de Yarn Berry, para indicar que no existe continuidad entre ellos, son proyectos distintos. **Yarn 2 y Yarn Berry son t√©rminos equivalentes**. Yarn 3 continua el camino iniciado por Yarn 2 y tambi√©n forma parte de Yarn Berry. 
   
   M√°s sobre esto: https://github.com/yarnpkg/berry/issues/766

A ra√≠z de la pol√©mica, Yarn aclar√≥ que la versi√≥n Classic ser√≠a la que se instalar√≠a por defecto, y que se podr√≠a actualizar por proyecto a la versi√≥n 2 con `yarn set version berry`.  Es por eso que en nuestro directorio ra√≠z, si hacemos `yarn -v`, vemos yarn 1.22.x y en nuestros proyectos vemos yarn 3.x.x.

A d√≠a de hoy, para poder garantizar la estabilidad del ecosistema y prevenir problemas, Yarn Classic sigue siendo la versi√≥n de facto cuando instalas `yarn`. Su feature estrella, PnP, sigue sin estar activada por defecto al actualizar a Yarn Berry. Tenemos que seguir un proceso adicional (que veremos adelante) para usarla. Lo cual da que pensar: ¬øc√≥mo apostar por una herramienta por que el ni siquiera sus autores pueden apostar definitivamente?


## ¬øD√≥nde estamos nosotros?
Actualmente en nuestra documentaci√≥n recomendamos el uso de **Yarn Berry**. Parece que obtenemos [alguna ventaja al comitear la cach√© de yarn a Github](https://youtu.be/fFpFdD3ExFo). Pero despu√©s de todo este tiempo, el directorio de `node_modules` sigue en nuestros proyectos. No usamos PnP, y parece complicado que podamos empezar a hacerlo, porque es conocido que puede presentar incompatibilidades con algunas librer√≠as y representa un proceso de migraci√≥n que no es trivial.

En nuestros proyectos, cuando hacemos upgrade de Yarn Classic a Yarn Berry, en el archivo `.yarnrc.yarm` se crea una propiedad `nodeLinker` con el valor de `node_modules`. Es la manera que tiene YB de configurar el uso de node modules por defecto. Para usar PnP hay que borrar esa l√≠nea y correr el comando `yarn`. 

## ¬øDeber√≠amos intentar adoptar PnP?
PnP parece realmente eficiente a nivel de performance. Yarn ha estado trabajando desde el lanzamiento para mejorar la compatibilidad desde el lanzamiento, incluso haciendo PR a conocidas librer√≠as para integrar PnP, pero a√∫n parece problem√°tico. 

He le√≠do a usuarios que comentan que han podido hacerlo sin grandes problemas en aplicaciones de tama√±o peque√±o y medio, pero lo habitual es leer advertencias sobre lo complicada que puede ser la migraci√≥n. 

### Prueba de migraci√≥n a PnP
Para hacerme una idea de c√≥mo ser√≠a el proceso, he intentado migrar Baselang a PnP, pero no he sido capaz de llevar la migraci√≥n a buen t√©rmino. Yarn Berry cuenta con [una gu√≠a sospechosamente detallada de migraci√≥n], aunque ellos mismos advierten de que puede ser un proceso dif√≠cil para proyectos existentes. La idea, no obstante, ser√≠a usar PnP en proyectos nuevos. 

**Proceso en lineas generales**:
- Borr√© la l√≠nea de `nodeLinker` en `.yarnrc.yml` y corr√≠ el comando `yarn`. Con esto ya tenemos PnP y se borra casi todo el contenido de `node_modules`. Adem√°s, se generan un par de archivos `.pnp*`, que especifican c√≥mo hacer la resoluci√≥n de m√≥dulos. Es el c√≥digo que se encarga de seleccionar y extraer los archivos comprimidos en runtime.
- Lanc√© `yarn start` y empec√© a encontrar problemas de `peer dependencies`. Lo arregl√© como indica aqu√≠: https://yarnpkg.com/getting-started/migration#fix-dependencies-with-packageextensions
- Despu√©s de arreglar un par de dependencias de esa manera, encontr√© un nuevo error al lanzar la aplicaci√≥n: "Cannot find module `react-focus-trap`". [Seg√∫n la documentaci√≥n](https://yarnpkg.com/getting-started/migration#cannot-find-module-) de Yarn esto no es un error de ellos, si no de como est√° configurado el entorno de node. Lo pude arreglar borrando `.yarnrc.yml` y volviendo a lanzar `yarn`.
- Adem√°s, como la mayor√≠a de editores est√°n hechos para funcionar con `node_modules`, existen incompatibilidades con el IDE, con extensiones como la de Prettier. Para arreglarlo tienes que a√±adir una dependencia que gestiona la integraci√≥n. https://yarnpkg.com/getting-started/editor-sdks
- Tambi√©n tuve que especificar que la versi√≥n de Typescript es la del workspace: `Settings > Typescript: Select TS version > use workspace version`
- En este punto, el IDE empez√≥ a lanzar errores relacionados con `stylelint` y `post css` que no supe solucionar.

Probablemente, lo hubiera conseguido de seguir insistiendo, pero la pregunta es, ¬ødeber√≠a ser tan dif√≠cil? Las innovaciones de PnP, de alg√∫n modo, constituyen su principal desventaja. En lugar de adecuarse a ti, te obligan a jugar al juego de YB, con sus reglas de configuraci√≥n y sus particularidades. 

## ¬øQu√© alternativas tenemos?

En esta situaci√≥n, se plantean dos opciones.

### 1. Quedarnos como estamos. 

> "Si no est√° roto no lo rompas".  

Yarn Berry no es mal sistema, pero creo que no podemos plantearnos asumir PnP en el medio plazo, o de hacerlo, tenemos que asumir tantas peculiaridades que nos estamos encerrando en un modo de configuraci√≥n que parece ir a contracorriente.
Podemos seguir us√°ndolo con `node_modules`, como venimos haciendo hasta ahora. La configuraci√≥n sigue siendo un poco m√°s complicada que con otros gestores, pero es algo que tenemos documentado y solo da problemas puntuales. 

Por otra parte volver a Yarn Classic no tiene demasiado sentido, porque es un proyecto en fase de mantenimiento.

Mi sensaci√≥n, a pesar de todo, es que el mayor argumento para seguir con Yarn Berry es que ya lo estamos usando.  

### 2. Mirar qu√© nuevos players existen en la gesti√≥n de dependencias

Performant npm, `pnpm`, es un gestor de dependencias cuya primera versi√≥n apareci√≥ en 2017, y va por su versi√≥n 7. En el √∫ltimo par de a√±os se ha popularizado mucho y est√° ganando una r√°pida adopci√≥n. NextJs, por ejemplo, [est√° empezando a usarlo](https://github.com/vercel/next.js/pull/37259). 

**¬øEn qu√© se diferencia?** Pnpm trabaja con `node modules`, no propone un sistema tan rupturista como Yarn Berry, pero si que cuenta con una gran innovaci√≥n y es c√≥mo trata ese directorio de `node modules`. Yarn y npm duplican las dependencias cada vez que son requeridas. Es decir, si varios proyectos (o sus respectivas dependencias) usan una versi√≥n de una dependencia, se instala una copia por cada proyecto o dependencia de ese proyecto que la usa, lo cual aumenta el uso de disco considerablemente. 
Lo que `pnpm` hace de forma diferente es mantener crear una carpeta node modules con links que apuntan a un store global, por lo tanto solo existe una copia de cada dependencia necesaria. 
Incluso si los proyectos necesitan diferentes versiones de una misma dependencia, `pnpm` es capaz de saber en qu√© archivos esas versiones son diferentes y guardar solo los archivos que constituyen la diferencia, optimizando al m√°ximo el espacio en disco.

Aqu√≠ se explica en mayor detalle: https://pnpm.io/motivation

Otra caracter√≠stica de seguridad es que `pnpm` nos previene de usar dependencias de nuestras dependencias, lo cual es problem√°tico si m√°s tarde eliminamos la dependencia original o √©sta cambia sus dependencias.

Adem√°s de las ventajas en almacenamiento de disco, este sistema es muy r√°pido porque el tiempo de copia de archivos es menor. Es un sistema de de hecho Yarn y npm ya est√°n imitando. 

#### Prueba de migraci√≥n a pnpm
He creado una nueva rama en Baselang, para migrar a pnpm, de la misma manera que he hecho con Yarn Berry PnP. Me ha resultado m√°s dif√≠cil saber por donde empezar, porque no hay una gu√≠a clara de migraci√≥n. Luego me he dado cuenta de que no era necesaria. Estos son los pasos que he seguido:

- He instalado `pnpm`. La documentaci√≥n ofrece muchas maneras de hacerlo, yo lo he hecho con `brew`
- He corrido el comando `pnpm import`, que toma la informaci√≥n de los archivos .lock para crear el archivo `pnp-lock.yml`
- He borrado los archivos de configuraci√≥n de yarn y he sustituido las referencias a yarn por referencias a pnpm.
- He lanzando `yarn start`. Ha funcionado.
- He lanzando `yarn build`. Ha funcionado.

Honestamente, pensaba que me iba a encontrar con muchos errores, especialmente migrando desde Yarn en lugar de desde npm, pero no ha sido as√≠. Por supuesto, ser√≠an necesarias m√°s pruebas y actualizar nuestros flujos de CI para que fueran compatibles con pnpm (desconozco si existir√°n impedimentos mayores ah√≠).


## Yarn 2 vs pnpm

Algunos datos de benchmarking:
- El soporte de la comunidad es muy diferente entre proyectos. Yarn Berry cuenta con ~6K estrellas en Github, pnpm con ~21K. Como comparativa Yarn Classic tiene ~41K. Adem√°s, como sabemos, muchos actores del ecosistema han expresado directamente su rechazo a usar Yarn Berry.
- Parece que Yarn 2 Berry con PnP es el sistema m√°s r√°pido. Pero que pnpm es m√°s r√°pido que Yarn 2 con `node_modules`, que es lo que nosotros usamos. Benchmarking:
	- De terceros: https://blog.logrocket.com/javascript-package-managers-compared/#performance-disk-space-efficiency
	- De pnpm:  https://pnpm.io/benchmarks
	- De Yarn: https://yarnpkg.com/benchmarks
- A d√≠a de hoy, hay ning√∫n gran proyecto que use Yarn Berry con PnP.  https://blog.logrocket.com/javascript-package-managers-compared
- Aunque `pnpm` se mantiene por debajo en descargas con respecto a Yarn (1 + 2), tiene un volumen de descargas grande y muestra una tendencia r√°pida de crecimiento. 
- NextJs ha adoptado pnpm: https://github.com/vercel/next.js/pull/37259

En resumen:
- Yarn Berry requiere m√°s archivos de configuraci√≥n, diferentes de lo habitual,  requiere mayor compromiso con un sistema propio. Presenta incompatibilidades para usarlo en toda su capacidad. Su mayor ventaja es que ya lo estamos usando. 
- Por otra parte, pnpm "just works". Es un nuevo sistema que est√° ganando r√°pida adopci√≥n, es f√°cil de instalar y sus competidores est√°n copiando su manera de hacer las cosas.


## Propuesta de pasos a seguir
- [ ] Lectura de propuesta por parte del equipo
	- [ ] Presentaci√≥n de comentarios a favor/en contra verbalmente
- [ ] En caso de aprobarse el uso de `pnmp`, hacer m√°s pruebas y comprobar como ser√≠a la integraci√≥n con CI
- [ ] Test en un proyecto nuevo para validaci√≥n
- [ ] Actualizaci√≥n de la gu√≠a de inicio para recomendar el uso de pnpm
	- [ ] Presentaci√≥n del cambio en la reuni√≥n de front e indicaciones para su adopci√≥n


## Referencias

- Ben Awad, release of Y2. Explica la pol√©mica en torno a la aparici√≥n de Yarn 2 y las dudas sobre su adopci√≥n.: https://www.youtube.com/watch?v=bPae4Z8BFt8
- Yarn Berry: a next generation package manager https://www.youtube.com/watch?v=fFpFdD3ExFo
- Javascript packages managers compared https://blog.logrocket.com/javascript-package-managers-compared/
- Yarn 2, Yarn 3, PNP, and our migration journey - Jakub Zitny https://www.youtube.com/watch?v=egu0qvIEnTg
- Reddit Pnpm vs Yarn 2? https://www.reddit.com/r/learnjavascript/comments/k9i50i/pnpm_vs_yarn_2/
- Why I Switched From NPM/Yarn to PNPM https://www.youtube.com/watch?v=d1E31WPR70g
- Why you should prefer PNPM https://refine.dev/blog/pnpm-vs-npm-and-yarn/
- Yarn Berry state 2021 https://blog.hao.dev/state-of-yarn-2-berry-in-2021
- Migration from Yarn to pnpm https://divriots.com/blog/switching-to-pnpm

### Documentaci√≥n
- Yarn Pnp https://yarnpkg.com/features/pnp
- Yarn Pnp compatibility table https://yarnpkg.com/features/pnp#compatibility-table
- Yarn Berry migration https://yarnpkg.com/getting-started/migration
- Pnpm motivation https://pnpm.io/motivation
- Pnpm Yearn 2022 https://pnpm.io/blog/2022/12/30/yearly-update